<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ä¿¡ç´™åˆæˆå™¨ - åŒæ­¥ä¿®æ­£ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @font-face {
            font-family: 'ChenYuluoyan';
            src: url('ChenYuluoyan-2.0-Thin.ttf') format('truetype');
            font-weight: normal; font-style: normal; font-display: swap;
        }

        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #f4f4f4; padding: 20px; }
        .container { display: flex; gap: 30px; background: white; padding: 30px; border-radius: 12px; max-width: 1000px; }
        .editor { width: 450px; display: flex; flex-direction: column; gap: 15px; }
        
        /* é è¦½å€ï¼šå¾®èª¿ padding ä»¥æ‡‰å° Canvas èª¤å·® */
        .preview-area { 
            width: 450px; height: 636px; 
            background-image: url('letter01.jpg'); 
            background-size: cover; 
            padding: 85px 52px 50px 52px; /* ç¨å¾®ç¸®å°åº•éƒ¨ padding çµ¦æ–‡å­—æ›´å¤šç·©è¡ */
            box-sizing: border-box;
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            background-color: white; /* é¿å…é€æ˜èƒŒæ™¯å°è‡´ SecurityError */
        }

        .letter-text {
            font-family: 'ChenYuluoyan', 'Noto Serif TC', serif;
            word-break: break-all; overflow-wrap: break-word;
            white-space: pre-wrap; color: #3A4A5B;
            /* é—œéµï¼šå¼·åˆ¶è¨­å®šå­—é«”å¹³æ»‘åº¦ï¼Œæ¸›å°‘æˆªåœ–è½å·® */
            -webkit-font-smoothing: antialiased;
        }

        #out-to { font-size: 1.3rem; font-weight: bold; margin-bottom: 8px; flex-shrink: 0; }
        
        /* æ ¸å¿ƒå„ªåŒ–ï¼šç¨å¾®é™ä½è¡Œé«˜ä¸¦å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢ Canvas æ¸²æŸ“æ™‚æ¨æ“ æ–‡å­— */
        #out-body { 
            flex: 1; 
            font-size: 1.1rem; 
            line-height: 1.6; /* å¾ 1.7 ç¸®æ¸›åˆ° 1.6ï¼ŒæŠµéŠ· Canvas çš„å¯¬åº¦è†¨è„¹ */
            font-weight: 500; 
            overflow: hidden;
            max-height: 420px; /* å¼·åˆ¶æ­£æ–‡å€æœ€é«˜é«˜åº¦ */
        }

        #out-from { text-align: right; font-size: 1.2rem; margin-top: 5px; flex-shrink: 0; }
        
        .control-group { position: relative; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 0.9rem; color: #444; }
        .word-counter { position: absolute; right: 0; top: 0; font-size: 0.75rem; color: #888; }
        .warning-text { color: #e53e3e; font-weight: bold; font-size: 0.85rem; display: none; margin-top: 8px; }

        input, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        textarea { min-height: 350px; resize: vertical; background-color: #fafafa; }
        
        button { background: #4a5568; color: white; border: none; padding: 16px; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 1rem; }
        .btn-clear { background: #feb2b2; color: #9b2c2c; padding: 10px; font-size: 0.85rem; border: none; border-radius: 6px; cursor: pointer; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="editor">
            <h2 style="margin-top:0">âœï¸ å¯«å°ä¿¡çµ¦ Yoruno</h2>
            <div class="control-group">
                <label>æ”¶ä»¶äºº</label>
                <input type="text" id="in-to" placeholder="è¦ªæ„›çš„...">
            </div>
            <div class="control-group">
                <label>ä¿¡ä»¶å…§å®¹ (ä¸è¨ˆæ›è¡Œ)</label>
                <textarea id="in-body" placeholder="å…§å®¹é™å¯¦è³ªæ–‡å­— 200 å­—å…§..."></textarea>
                <div class="word-counter"><span id="char-count">0</span> / 200</div>
                <div id="overflow-warn" class="warning-text">âš ï¸ å…§å®¹éé•·ï¼Œä¸‹è¼‰åœ–å¯èƒ½æœƒè¢«è£åˆ‡ï¼</div>
            </div>
            <div class="control-group">
                <label>ä½ çš„ç½²å</label>
                <input type="text" id="in-from" placeholder="Yours...">
            </div>
            <button onclick="saveImage()">ğŸ’¾ å„²å­˜é«˜æ¸…ä¿¡ä»¶</button>
            <button class="btn-clear" onclick="clearDraft()">ğŸ—‘ï¸ æ¸…ç©ºé‡å¯«</button>
        </div>
        
        <div id="letter-capture" class="preview-area">
            <div id="out-to" class="letter-text"></div>
            <div id="out-body" class="letter-text"></div>
            <div id="out-from" class="letter-text"></div>
        </div>
    </div>

    <script>
        const ids = ['in-to', 'in-body', 'in-from'];
        
        window.onload = () => {
            ids.forEach(id => {
                const saved = localStorage.getItem(id);
                if (saved) {
                    document.getElementById(id).value = saved;
                    document.getElementById(id.replace('in-', 'out-')).innerText = saved;
                }
            });
            checkOverflow();
        };

        function checkOverflow() {
            const outBody = document.getElementById('out-body');
            const warn = document.getElementById('overflow-warn');
            const textarea = document.getElementById('in-body');
            
            const cleanLength = textarea.value.replace(/\n/g, '').length;
            document.getElementById('char-count').innerText = cleanLength;
            document.getElementById('char-count').style.color = cleanLength > 200 ? '#e53e3e' : '#888';

            // é ç•™ä¸€é»ç·©è¡ç©ºé–“ (clientHeight - 5)
            if (outBody.scrollHeight > outBody.clientHeight - 5) {
                warn.style.display = 'block';
                outBody.style.backgroundColor = "rgba(229, 62, 62, 0.05)";
            } else {
                warn.style.display = 'none';
                outBody.style.backgroundColor = "transparent";
            }
        }

        ids.forEach(id => {
            document.getElementById(id).oninput = e => {
                document.getElementById(id.replace('in-', 'out-')).innerText = e.target.value;
                localStorage.setItem(id, e.target.value);
                if (id === 'in-body') checkOverflow();
            };
        });

        function clearDraft() {
            if (confirm("ç¢ºå®šè¦æ¸…é™¤è‰ç¨¿å—ï¼Ÿ")) { localStorage.clear(); location.reload(); }
        }

        async function saveImage() {
            const btn = document.querySelector('button');
            const captureArea = document.getElementById('letter-capture');
            btn.innerText = "åŒæ­¥æ¸²æŸ“ä¸­...";
            
            try {
                // å„ªåŒ–æ¸²æŸ“åƒæ•¸ï¼šåŠ å…¥ logging å’Œ backgroundColor
                const canvas = await html2canvas(captureArea, { 
                    scale: 3, 
                    useCORS: true,
                    backgroundColor: "#ffffff",
                    logging: false,
                    onclone: (clonedDoc) => {
                        // åœ¨æˆªåœ–ç¬é–“å¾®èª¿å…‹éš†å…ƒç´ çš„æ¨£å¼ï¼Œç¢ºä¿ 100% åŒæ­¥
                        const body = clonedDoc.getElementById('out-body');
                        body.style.lineHeight = "1.6";
                    }
                });
                
                const link = document.createElement('a');
                link.download = `Letter_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                btn.innerText = "ğŸ’¾ å„²å­˜é«˜æ¸…ä¿¡ä»¶";
            } catch (err) {
                console.error(err);
                alert("å„²å­˜å¤±æ•—ï¼šå¯èƒ½æ˜¯åœ–ç‰‡æ¬Šé™å•é¡Œã€‚è«‹ç¢ºä¿åœ–ç‰‡æ”¾åœ¨ GitHub ä¸Šã€‚");
                btn.innerText = "ğŸ’¾ å„²å­˜é«˜æ¸…ä¿¡ä»¶";
            }
        }
    </script>
</body>
</html>
